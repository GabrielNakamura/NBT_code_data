{"title":"Supplementary material - Figures and Tables","markdown":{"yaml":{"title":"Supplementary material - Figures and Tables","subtitle":"0010_Supplementary_analysis.qmd","format":"html","eval":true,"warning":false,"knitr":{"opts_chunk":{"message":false}}},"headingText":"Native species richness","containsRefs":false,"markdown":"\n\nIn this document we provide the code to reproduce the Figures and Tables presented in supplementary material of the manuscript **\"The macroecology of knowledge: Spatio-temporal patterns of name-bearing types in biodiversity science\"**\n\n```{r}\nlibrary(readr) # read csv objects\nlibrary(dplyr) # manipulate tables\nlibrary(ggplot2) # plot figures\nlibrary(scales) # change axis values\nlibrary(countrycode) # download country information\n```\n\n\nWe calculate the native species richness for each country from data in the Catalog of Fishes. We used this source to avoid taxonomic mismatches between species names.\n\n```{r}\n# Data from 01_C_data_preparation.qmd\ndf_country_native <- readr::read_csv(file = here::here(\"data\",\"processed\", \"df_country_native.csv\"))\n\n```\n\n```{r}\ncountries <- \n  rnaturalearth::ne_countries(scale = \"medium\",\n                                         returnclass = \"sf\") |>\n  dplyr::filter(region_wb != \"Antarctica\")|>\n  rmapshaper::ms_filter_islands(min_area = 20000000000) |>\n  rmapshaper::ms_simplify(keep = 0.95)\n\nsf_countries <-\n  sf::st_as_sf(countries) |>\n  dplyr::filter(admin != \"Antarctica\") |> \n  dplyr::select(iso_a3)\n\ndf_country_native_sf <-\n  sf_countries |>\n  dplyr::full_join(df_country_native, \n                   by = c(iso_a3 = \"country_distribution\"))\n```\n\n## Figure S1 - Native richness\n\nNative richness was extracted from the Catalog of Fishes\n\n```{r}\n#| fig-width: 7\n#| fig-height: 5\n\ndf_country_native_sf |>\n  ggplot()+\n  geom_sf(aes(fill = native.richness))+\n  scale_fill_distiller(palette = \"YlGnBu\",\n                       direction = 1,\n                       na.value = \"grey90\",\n                       breaks = c(1, 1000, 2000,3000, 3854))+\n  labs(\n    fill = \"Native richness\"\n  )+\n  guides(fill = guide_colorbar(barwidth = 20))+\n  theme_void()+\n  theme(\n    legend.position = \"top\",\n    legend.title.position = \"top\",\n    legend.title = element_text(hjust = 0.5),\n    plot.background = element_rect(fill = \"white\",\n                                   color = NA)\n  )+\n  coord_sf(\n    crs = \"+proj=moll +x_50=0 +y_0=0 +lat_0=0 +lon_0=0\"\n    )\n\nggsave(here::here(\"output\", \"figures\",\n                  \"Supp-material\", \"FigS1_native_richness.png\"),\n       width = 7, height = 5, dpi = 600)\n```\n\n# All time Domestic Contribution (DC) and Domestic Retention (DR)\n\nHere we provided all time values of DR and DC for each region. We used the same data from Figure 2 of the main text, but pulling together all the data \n\n```{r}\n# Data from 01_C_data_preparation.qmd\nflow_region_prop <- readr::read_csv(file = here::here(\"data\", \"processed\", \"flow_region_prop.csv\"))\n```\n\n## Figure S2 - Scatterplot of all-time\n\n```{r}\n#| fig-width: 3.5\n#| fig-height: 3\n\nflow_region_prop |>\n  ggplot(aes(x = prop_DC, y = prop_DR, fill = region_type))+\n  geom_hline(yintercept = 0.5, linetype = \"dashed\")+\n  geom_vline(xintercept = 0.5, linetype = \"dashed\")+\n  geom_point(\n    shape = 21,\n    size = 2.5\n  )+\n  scale_fill_manual(\n    values = c(\n      \"Europe & Central Asia\" = \"#E64B35FF\",\n      \"East Asia & Pacific\" = \"#4DBBD5FF\",\n      \"North America\" = \"#3C5488FF\",\n      \"South Asia\" = \"#B09C85FF\",\n      \"Latin America & Caribbean\" = \"#00A087FF\",\n      \"Sub-Saharan Africa\" = \"#F39B7FFF\",\n      \"Middle East & North Africa\" = \"#8491B4FF\"\n    )\n  )+\n  scale_x_continuous(\n    labels = scales::label_percent(),\n    expand = expansion(mult = c(0.05, 0))\n  )+\n  scale_y_continuous(\n    labels = scales::label_percent(),\n    expand = expansion(mult = c(0.05, 0))\n  )+\n  labs(\n    x = \"Domestic Constribution (DC)\",\n    y = \"Domestic Retention (DR)\"\n  )+\n  theme_classic()+\n  theme(\n    strip.background = element_rect(fill = NA, color = NA),\n    strip.text = element_text(face = \"bold\"),\n    legend.position = \"none\",\n    plot.background = element_blank(),\n    panel.spacing = unit(5, \"pt\"),\n    panel.spacing.x = unit(15, \"pt\"),\n    plot.margin = margin(5,15,5,5,\"pt\"),\n    axis.line = element_line(lineend = \"round\"),\n    axis.text = element_text(color = \"black\"),\n    axis.ticks = element_line(color = \"black\")\n  )+\n  coord_cartesian(xlim = c(0,1),\n                  ylim = c(0,1),\n                  clip = \"off\")\n\n# saving image\nggsave(filename = here::here(\"output\", \"figures\", \"Supp-material\", \"FigS2_scatterplot.png\"), \n       width = 3.5, height = 3)\n```\n# Calculating turnover metrics with full native dataset\n\n## Reading packages\n\n```{r packages}\n# data\nlibrary(readr)        # reading CSV files\nlibrary(here)         # constructing file paths\nlibrary(dplyr)        # data manipulation\nlibrary(tidyr)        # data tidying\nlibrary(phyloregion)  # handling phylogenetic data and transformations\n```\n\n## Importing and processing data \n\nImporting and processing native composition and NBT composition data\n\n```{r}\n# From 01_C_data_preparation.qmd\nspp_native_distribution <- readr::read_csv(here::here(\"data\", \"raw\", \"spp_native_distribution.csv\")) \n\n# From 01_C_data_preparation.qmd\nspp_type_distribution <- readr::read_csv(here::here(\"data\", \"raw\", \"spp_type_distribution.csv\")) \n```\n\nChecking the specimens with data in both tables (native distribution and types). We transformed the long format species occurrence data frame to dense format. During this procedure we removed 1204 species that do not have information on native distribution (or we couldn't get this information from CAS)\n\n```{r}\ndf_native_grid <- \n  spp_native_distribution |> \n  dplyr::select(grids = country_distribution, \n                species = species) |> \n  tidyr::drop_na(grids)\n\ndf_type_grid <- \n  spp_type_distribution |> \n  dplyr::select(grids = country_museum, \n                species = species) |> \n  tidyr::drop_na(grids) |> \n  dplyr::mutate(grids = paste(grids, \"type\", sep = \"_\"))\n  \n\n# joining data frames\ndf_all_grid <- rbind(df_native_grid, df_type_grid) # joining both matrices - \n    #native and types composition\n\n#### Just descriptive quantities\ncountry_native <- unique(df_native_grid$grids)\ncountry_type <- gsub(pattern = \"_type\", \n                     replacement = \"\",\n                     unique(df_type_grid$grids))\ncountry_type_zero <- setdiff(country_native, country_type) # countries with no type specimen\n\n# transforming into a sparse matrix to speed up calculations\nsparse_all <- df_all_grid |> \n  phyloregion::long2sparse(grids = \"grids\", species = \"species\") |> \n  phyloregion::sparse2dense()\n\n# Transforming in presence absence matrix\nsparse_all_pa <- ifelse(sparse_all >= 1, 1, 0) \n\n# Binding countries with no types - adding zeroes\ncountry_type_zero_names <- paste(country_type_zero, \"_type\", sep = \"\") # this will be used to bind together matrix with types and add the countries with no type\nmatrix_type_zero <- matrix(0,\n         nrow = length(country_type_zero_names),\n         ncol = ncol(sparse_all_pa), \n         dimnames = list(country_type_zero_names, \n                         colnames(sparse_all_pa)))\n\nsparse_all_pa2 <- rbind(sparse_all_pa, matrix_type_zero)\n\n```\n\n## Calculating directional turnover based on native and primary type comparison\n\nHere we calculated the turnover in two directions. One is the turnover of native composition, in other words, the underrepresentation of native fish species in museums and natural collections within the country. Values closer to one indicate that the country present a huge underepresentation of its native fish fauna in primary types located within the country. \n\nThe other metric is primary type turnover. Values approaching one indicate that there is an overepresentation of primary types maintained in the country when compared to the native fish fauna of that country.\n\n```{r}\nsource(here::here(\"R\", \"functions\", \"function_beta_types_success_fail.R\"))\n\nnames_countries <- unique(df_native_grid$grids) # country names\n\ndf_all_beta <- beta_types(presab = sparse_all_pa2, \n                          names.countries = names_countries) # calculating metrics of directional turnover\n\nreadr::write_csv(df_all_beta, here::here(\"data\", \"processed\", \"df_all_beta.csv\"))\n```\n\n\n# Plotting native and NBT turnover for each country\n\nIn this section we present the cartogram of world map with values of native and \n    NBT turnover using the full dataset of native species (Figure S4)\n\n## Loading packages\n\n```{r}\n#plot\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(cowplot)\n#map\nlibrary(rnaturalearth)\nlibrary(rmapshaper)\nlibrary(sf)\nlibrary(biscale)\n```\n\n## Data\n\n```{r}\n# Data from 02_D_beta-countries.qmd\ndf_all_beta <- readr::read_csv(here::here(\"data\", \"processed\", \"df_all_beta.csv\"))\n```\n\n## Joining metric information with geographical data\n\n```{r}\ncountries <- rnaturalearth::ne_countries(returnclass = \"sf\")\n\nsf_countries <-\n  sf::st_as_sf(countries) |>\n  dplyr::filter(admin != \"Antarctica\") |>\n  sf::st_transform(crs = \"+proj=moll +x_0=0 +y_0=0 +lat_0=0 +lon_0=0\") |> \n  dplyr::select(iso_a3_eh)\n\ndf_all_beta_sf <-\n  sf_countries |>\n  dplyr::full_join(df_all_beta, by = c(iso_a3_eh = \"countries\"))\n\n```\n\nFirst processing spatial data to convert NA values into 0\n\n```{r}\ndf_all_beta_sf2 <- \n  df_all_beta_sf |> \n  sf::st_as_sf() |> \n  rmapshaper::ms_filter_islands(min_area = 12391399903) |> \n  dplyr::mutate(\n    type.beta = ifelse(is.na(type.beta), \n                           0, \n                           type.beta),\n    native.beta = ifelse(is.na(native.beta), \n                           0, \n                           native.beta))\n```\n\n## Create palettes\n\n```{r}\npalette_blue <- colorRampPalette(c(\"#d3d3d3\", \"#accaca\", \"#81c1c1\", \"#52b6b6\"))\n\npalette_pink <- colorRampPalette(c(\"#d3d3d3\", \"#c5acc2\", \"#bb84b1\", \"#ac5a9c\"))\n\n```\n\n## Plotting maps\n\n```{r}\nmap_native_beta <- \n  ggplot() +\n  geom_sf(data = df_all_beta_sf2,\n          aes(geometry = geometry,\n              fill = native.beta),\n          color = \"white\",\n          size = 0.1, na.rm = T) +\n  scale_fill_gradientn(\n    colors = palette_pink(10),\n    na.value = \"#d3d3d3\",\n    limits = c(0,1)\n  )+\n  guides(fill = guide_colorbar(\n    barheight = unit(0.1, units = \"in\"),\n    barwidth =  unit(4, units = \"in\"),\n    ticks.colour = \"grey20\",\n    title.position=\"top\", \n    title.hjust = 0.5\n  )) +\n  labs(\n    fill = \"Native\"\n  )+\n  theme_classic()+\n  theme(\n    legend.position = \"bottom\",\n    legend.margin = margin(-10,0,0,0,\"pt\"),\n    axis.text = element_blank(),  \n    axis.ticks = element_blank(),\n    axis.line = element_blank()\n  ) \n\nmap_type_beta <- \n  ggplot() +\n  geom_sf(data = df_all_beta_sf2,\n          aes(geometry = geometry,\n              fill = type.beta),\n          color = \"white\",\n          size = 0.1, na.rm = T) +\n  scale_fill_gradientn(\n    colors = palette_blue(10),\n    na.value = \"#d3d3d3\",\n    limits = c(0,1)\n  )+\n  guides(fill = guide_colorbar(\n    barheight = unit(0.1, units = \"in\"),\n    barwidth =  unit(4, units = \"in\"),\n    ticks.colour = \"grey20\",\n    title.position=\"top\", \n    title.hjust = 0.5\n  )) +\n  labs(\n    fill = \"Types\"\n  )+\n  theme_classic()+\n  theme(\n    legend.position = \"bottom\",\n    legend.margin = margin(-10,0,0,0,\"pt\"),\n    axis.text = element_blank(),  \n    axis.ticks = element_blank(),\n    axis.line = element_blank()\n  ) \n```\n\n## Plotting the two quantities (native and types turnover) in a bivariate map\n\n```{r}\nsf_bivar_types <-\n  bi_class(df_all_beta_sf2, \n           x = type.beta, \n           y = native.beta, \n           style = \"equal\",\n           dim = 4)\n\nbivar_map_types <- \n  ggplot() +\n  geom_sf(data = sf_bivar_types, \n          aes(geometry = geometry,\n              fill = bi_class), \n          color = \"white\",\n          size = 0.1, \n          show.legend = FALSE) +\n  bi_scale_fill(pal = \"DkBlue2\", \n                dim = 4) +\n  theme_classic()+\n  theme(\n    legend.position = \"bottom\",\n    legend.title = element_blank(),\n        axis.text = element_blank(),  \n        axis.ticks = element_blank(),\n        axis.line = element_blank(),\n    panel.background = element_rect(fill = NA),\n    plot.background = element_rect(fill = NA)\n  ) \n\nlegend <-\n  bi_legend(pal = \"DkBlue2\",\n            dim = 4,\n            xlab = \"NBT\",\n            ylab = \"Native\",\n            size = )\n\nbivar_map_type_final <- \n  ggdraw() +\n  draw_plot(legend, 0.0, 0.15, 0.25, 0.25) +\n  draw_plot(bivar_map_types, 0, 0, 1, 1)\n\n```\n\n## Joining all the maps \n\n```{r}\n#| fig-width: 10\n#| fig-height: 9\n\nmap_turnover_all <-\n  map_native_beta+map_type_beta+bivar_map_type_final+\n  patchwork::plot_layout(\n    design = \n\"AB\n CC\"\n  )+\n  patchwork::plot_annotation(tag_levels = \"a\")&\n  theme(\n    plot.tag = element_text(face = \"bold\", hjust = 0, vjust = 1),\n    plot.tag.position = c(0, 1),\n  )\nmap_turnover_all\n\nggsave(here::here(\"output\", \"figures\", \"FigS4_turnover_metrics.png\"),\n       map_turnover_all, dpi=600, width = 10, height = 9)\n\n```\n\n# Comparison between full dataset and endemic dataset\n\nWe performed correlations between Native and NBT turnover calculated using\n    the endemic dataset and the full dataset of native species\n\n```{r}\ndf_endemic_beta <- readr::read_csv(here::here(\"data\", \"processed\", \"df_endemic_beta.csv\"))\n\ndf_endemic_beta2 <- \n  df_endemic_beta |> \n  drop_na(type.beta) \ndf_all_beta_sf2 <- \n  df_all_beta_sf |> \n  drop_na(type.beta) \n\ndf_cor <- \n  df_endemic_beta2 |> \n  left_join(df_all_beta_sf2, by = c(countries = \"iso_a3_eh\")) \n\ncor(df_cor$type.beta.x, df_cor$type.beta.y)\ncor(df_cor$native.beta.x, df_cor$native.beta.y)\n\n```\n\n\n# Model results\n\nHere we report tables containing full results of the generalized linear models\n    presented in the main text . Also we report residuals diagnostic plots using\n    [DHARMa](https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html) package\n\n```{r}\nlibrary(sjPlot)    # creating summary tables of model results\nlibrary(glmmTMB)   # read model output objects\nlibrary(DHARMa)    # diagnostic graphics of models\nlibrary(here)      # constructing file paths\n```\n\n## Model data\n\nReading model results\n\n```{r}\n# Data from 03_C_data_preparation.qmd\ndf_country_complete6 <- readr::read_csv(here::here(\"data\", \"processed\", \"df_country_complete6.csv\"))\n\n# Data from 04_D_model_NBTs.qmd\nmod_counting_NBT <- readRDS(here::here(\"output\", \n                                       \"models\", \n                                       \"model_res_counting.rds\")) # NBT total countings\nmod_DC <- readRDS(here::here(\"output\", \n                             \"models\", \n                             \"model_res_dc.rds\"))\nmod_DR <- readRDS(here::here(\"output\", \n                             \"models\", \n                             \"model_res_dr.rds\"))\nmod_turnover_native <- readRDS(here::here(\"output\", \n                                          \"models\",\n                                      \"model_res_turnover_native.rds\"))\nmod_turnover_nbt <- readRDS(here::here(\"output\", \n                                       \"models\",\n                                       \"model_res_turnover_nbt.rds\"))\n\n```\n\n## Tables with estimated parameters\n\nProducing tables with model parameters. These tables corresponds to the Tables S1 to \n    S5 in the Supplementary material\n\n```{r}\n\n# Table with model parameters for total number of NBT\nsjPlot::tab_model(mod_counting_NBT, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\", \n                                  \"Dispersion parameter\"), \n                  dv.labels = \"Total Name Bearing Types\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n\n\n\n```\n\n```{r}\n# Table with parameter for Domestic contribution as the response variable\n\nsjPlot::tab_model(mod_DC, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"Domestic Contribution\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n\n```\n\n```{r}\n# Table with parameters for model with Domestic retention as response variable\n\nsjPlot::tab_model(mod_DR, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"Domestic Retention\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n```\n\n```{r}\n# Table with parameter from model with native turnover as response variable\n\nsjPlot::tab_model(mod_turnover_native, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"Native turnover\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n```\n\n```{r}\n# Table with parameters from model with nbt turnover as response variable\n\nsjPlot::tab_model(mod_turnover_nbt, \n                  transform = NULL,\n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"NBT turnover\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n\n\n\n```\n\n\n## Diagnostic graphics\n\nQQ-plots and residuals x predicted plots using DHARMa package. These plots are \n    used to compose the Figure S4 in the Supplementary material\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# total number of NBT\nDHARMa::simulateResiduals(fittedModel = mod_counting_NBT, plot = T)\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# Domestic Contribution and Domestic Retention\nDHARMa::simulateResiduals(fittedModel = mod_DC, plot = TRUE) # DC\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\nDHARMa::simulateResiduals(fittedModel = mod_DR, plot = TRUE) # DR\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# native turnover\nDHARMa::simulateResiduals(fittedModel = mod_turnover_native, plot = TRUE)\n\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# NBT turnover\nDHARMa::simulateResiduals(fittedModel = mod_turnover_nbt, plot = TRUE)\n```\n\n","srcMarkdownNoYaml":"\n\nIn this document we provide the code to reproduce the Figures and Tables presented in supplementary material of the manuscript **\"The macroecology of knowledge: Spatio-temporal patterns of name-bearing types in biodiversity science\"**\n\n```{r}\nlibrary(readr) # read csv objects\nlibrary(dplyr) # manipulate tables\nlibrary(ggplot2) # plot figures\nlibrary(scales) # change axis values\nlibrary(countrycode) # download country information\n```\n\n# Native species richness\n\nWe calculate the native species richness for each country from data in the Catalog of Fishes. We used this source to avoid taxonomic mismatches between species names.\n\n```{r}\n# Data from 01_C_data_preparation.qmd\ndf_country_native <- readr::read_csv(file = here::here(\"data\",\"processed\", \"df_country_native.csv\"))\n\n```\n\n```{r}\ncountries <- \n  rnaturalearth::ne_countries(scale = \"medium\",\n                                         returnclass = \"sf\") |>\n  dplyr::filter(region_wb != \"Antarctica\")|>\n  rmapshaper::ms_filter_islands(min_area = 20000000000) |>\n  rmapshaper::ms_simplify(keep = 0.95)\n\nsf_countries <-\n  sf::st_as_sf(countries) |>\n  dplyr::filter(admin != \"Antarctica\") |> \n  dplyr::select(iso_a3)\n\ndf_country_native_sf <-\n  sf_countries |>\n  dplyr::full_join(df_country_native, \n                   by = c(iso_a3 = \"country_distribution\"))\n```\n\n## Figure S1 - Native richness\n\nNative richness was extracted from the Catalog of Fishes\n\n```{r}\n#| fig-width: 7\n#| fig-height: 5\n\ndf_country_native_sf |>\n  ggplot()+\n  geom_sf(aes(fill = native.richness))+\n  scale_fill_distiller(palette = \"YlGnBu\",\n                       direction = 1,\n                       na.value = \"grey90\",\n                       breaks = c(1, 1000, 2000,3000, 3854))+\n  labs(\n    fill = \"Native richness\"\n  )+\n  guides(fill = guide_colorbar(barwidth = 20))+\n  theme_void()+\n  theme(\n    legend.position = \"top\",\n    legend.title.position = \"top\",\n    legend.title = element_text(hjust = 0.5),\n    plot.background = element_rect(fill = \"white\",\n                                   color = NA)\n  )+\n  coord_sf(\n    crs = \"+proj=moll +x_50=0 +y_0=0 +lat_0=0 +lon_0=0\"\n    )\n\nggsave(here::here(\"output\", \"figures\",\n                  \"Supp-material\", \"FigS1_native_richness.png\"),\n       width = 7, height = 5, dpi = 600)\n```\n\n# All time Domestic Contribution (DC) and Domestic Retention (DR)\n\nHere we provided all time values of DR and DC for each region. We used the same data from Figure 2 of the main text, but pulling together all the data \n\n```{r}\n# Data from 01_C_data_preparation.qmd\nflow_region_prop <- readr::read_csv(file = here::here(\"data\", \"processed\", \"flow_region_prop.csv\"))\n```\n\n## Figure S2 - Scatterplot of all-time\n\n```{r}\n#| fig-width: 3.5\n#| fig-height: 3\n\nflow_region_prop |>\n  ggplot(aes(x = prop_DC, y = prop_DR, fill = region_type))+\n  geom_hline(yintercept = 0.5, linetype = \"dashed\")+\n  geom_vline(xintercept = 0.5, linetype = \"dashed\")+\n  geom_point(\n    shape = 21,\n    size = 2.5\n  )+\n  scale_fill_manual(\n    values = c(\n      \"Europe & Central Asia\" = \"#E64B35FF\",\n      \"East Asia & Pacific\" = \"#4DBBD5FF\",\n      \"North America\" = \"#3C5488FF\",\n      \"South Asia\" = \"#B09C85FF\",\n      \"Latin America & Caribbean\" = \"#00A087FF\",\n      \"Sub-Saharan Africa\" = \"#F39B7FFF\",\n      \"Middle East & North Africa\" = \"#8491B4FF\"\n    )\n  )+\n  scale_x_continuous(\n    labels = scales::label_percent(),\n    expand = expansion(mult = c(0.05, 0))\n  )+\n  scale_y_continuous(\n    labels = scales::label_percent(),\n    expand = expansion(mult = c(0.05, 0))\n  )+\n  labs(\n    x = \"Domestic Constribution (DC)\",\n    y = \"Domestic Retention (DR)\"\n  )+\n  theme_classic()+\n  theme(\n    strip.background = element_rect(fill = NA, color = NA),\n    strip.text = element_text(face = \"bold\"),\n    legend.position = \"none\",\n    plot.background = element_blank(),\n    panel.spacing = unit(5, \"pt\"),\n    panel.spacing.x = unit(15, \"pt\"),\n    plot.margin = margin(5,15,5,5,\"pt\"),\n    axis.line = element_line(lineend = \"round\"),\n    axis.text = element_text(color = \"black\"),\n    axis.ticks = element_line(color = \"black\")\n  )+\n  coord_cartesian(xlim = c(0,1),\n                  ylim = c(0,1),\n                  clip = \"off\")\n\n# saving image\nggsave(filename = here::here(\"output\", \"figures\", \"Supp-material\", \"FigS2_scatterplot.png\"), \n       width = 3.5, height = 3)\n```\n# Calculating turnover metrics with full native dataset\n\n## Reading packages\n\n```{r packages}\n# data\nlibrary(readr)        # reading CSV files\nlibrary(here)         # constructing file paths\nlibrary(dplyr)        # data manipulation\nlibrary(tidyr)        # data tidying\nlibrary(phyloregion)  # handling phylogenetic data and transformations\n```\n\n## Importing and processing data \n\nImporting and processing native composition and NBT composition data\n\n```{r}\n# From 01_C_data_preparation.qmd\nspp_native_distribution <- readr::read_csv(here::here(\"data\", \"raw\", \"spp_native_distribution.csv\")) \n\n# From 01_C_data_preparation.qmd\nspp_type_distribution <- readr::read_csv(here::here(\"data\", \"raw\", \"spp_type_distribution.csv\")) \n```\n\nChecking the specimens with data in both tables (native distribution and types). We transformed the long format species occurrence data frame to dense format. During this procedure we removed 1204 species that do not have information on native distribution (or we couldn't get this information from CAS)\n\n```{r}\ndf_native_grid <- \n  spp_native_distribution |> \n  dplyr::select(grids = country_distribution, \n                species = species) |> \n  tidyr::drop_na(grids)\n\ndf_type_grid <- \n  spp_type_distribution |> \n  dplyr::select(grids = country_museum, \n                species = species) |> \n  tidyr::drop_na(grids) |> \n  dplyr::mutate(grids = paste(grids, \"type\", sep = \"_\"))\n  \n\n# joining data frames\ndf_all_grid <- rbind(df_native_grid, df_type_grid) # joining both matrices - \n    #native and types composition\n\n#### Just descriptive quantities\ncountry_native <- unique(df_native_grid$grids)\ncountry_type <- gsub(pattern = \"_type\", \n                     replacement = \"\",\n                     unique(df_type_grid$grids))\ncountry_type_zero <- setdiff(country_native, country_type) # countries with no type specimen\n\n# transforming into a sparse matrix to speed up calculations\nsparse_all <- df_all_grid |> \n  phyloregion::long2sparse(grids = \"grids\", species = \"species\") |> \n  phyloregion::sparse2dense()\n\n# Transforming in presence absence matrix\nsparse_all_pa <- ifelse(sparse_all >= 1, 1, 0) \n\n# Binding countries with no types - adding zeroes\ncountry_type_zero_names <- paste(country_type_zero, \"_type\", sep = \"\") # this will be used to bind together matrix with types and add the countries with no type\nmatrix_type_zero <- matrix(0,\n         nrow = length(country_type_zero_names),\n         ncol = ncol(sparse_all_pa), \n         dimnames = list(country_type_zero_names, \n                         colnames(sparse_all_pa)))\n\nsparse_all_pa2 <- rbind(sparse_all_pa, matrix_type_zero)\n\n```\n\n## Calculating directional turnover based on native and primary type comparison\n\nHere we calculated the turnover in two directions. One is the turnover of native composition, in other words, the underrepresentation of native fish species in museums and natural collections within the country. Values closer to one indicate that the country present a huge underepresentation of its native fish fauna in primary types located within the country. \n\nThe other metric is primary type turnover. Values approaching one indicate that there is an overepresentation of primary types maintained in the country when compared to the native fish fauna of that country.\n\n```{r}\nsource(here::here(\"R\", \"functions\", \"function_beta_types_success_fail.R\"))\n\nnames_countries <- unique(df_native_grid$grids) # country names\n\ndf_all_beta <- beta_types(presab = sparse_all_pa2, \n                          names.countries = names_countries) # calculating metrics of directional turnover\n\nreadr::write_csv(df_all_beta, here::here(\"data\", \"processed\", \"df_all_beta.csv\"))\n```\n\n\n# Plotting native and NBT turnover for each country\n\nIn this section we present the cartogram of world map with values of native and \n    NBT turnover using the full dataset of native species (Figure S4)\n\n## Loading packages\n\n```{r}\n#plot\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(cowplot)\n#map\nlibrary(rnaturalearth)\nlibrary(rmapshaper)\nlibrary(sf)\nlibrary(biscale)\n```\n\n## Data\n\n```{r}\n# Data from 02_D_beta-countries.qmd\ndf_all_beta <- readr::read_csv(here::here(\"data\", \"processed\", \"df_all_beta.csv\"))\n```\n\n## Joining metric information with geographical data\n\n```{r}\ncountries <- rnaturalearth::ne_countries(returnclass = \"sf\")\n\nsf_countries <-\n  sf::st_as_sf(countries) |>\n  dplyr::filter(admin != \"Antarctica\") |>\n  sf::st_transform(crs = \"+proj=moll +x_0=0 +y_0=0 +lat_0=0 +lon_0=0\") |> \n  dplyr::select(iso_a3_eh)\n\ndf_all_beta_sf <-\n  sf_countries |>\n  dplyr::full_join(df_all_beta, by = c(iso_a3_eh = \"countries\"))\n\n```\n\nFirst processing spatial data to convert NA values into 0\n\n```{r}\ndf_all_beta_sf2 <- \n  df_all_beta_sf |> \n  sf::st_as_sf() |> \n  rmapshaper::ms_filter_islands(min_area = 12391399903) |> \n  dplyr::mutate(\n    type.beta = ifelse(is.na(type.beta), \n                           0, \n                           type.beta),\n    native.beta = ifelse(is.na(native.beta), \n                           0, \n                           native.beta))\n```\n\n## Create palettes\n\n```{r}\npalette_blue <- colorRampPalette(c(\"#d3d3d3\", \"#accaca\", \"#81c1c1\", \"#52b6b6\"))\n\npalette_pink <- colorRampPalette(c(\"#d3d3d3\", \"#c5acc2\", \"#bb84b1\", \"#ac5a9c\"))\n\n```\n\n## Plotting maps\n\n```{r}\nmap_native_beta <- \n  ggplot() +\n  geom_sf(data = df_all_beta_sf2,\n          aes(geometry = geometry,\n              fill = native.beta),\n          color = \"white\",\n          size = 0.1, na.rm = T) +\n  scale_fill_gradientn(\n    colors = palette_pink(10),\n    na.value = \"#d3d3d3\",\n    limits = c(0,1)\n  )+\n  guides(fill = guide_colorbar(\n    barheight = unit(0.1, units = \"in\"),\n    barwidth =  unit(4, units = \"in\"),\n    ticks.colour = \"grey20\",\n    title.position=\"top\", \n    title.hjust = 0.5\n  )) +\n  labs(\n    fill = \"Native\"\n  )+\n  theme_classic()+\n  theme(\n    legend.position = \"bottom\",\n    legend.margin = margin(-10,0,0,0,\"pt\"),\n    axis.text = element_blank(),  \n    axis.ticks = element_blank(),\n    axis.line = element_blank()\n  ) \n\nmap_type_beta <- \n  ggplot() +\n  geom_sf(data = df_all_beta_sf2,\n          aes(geometry = geometry,\n              fill = type.beta),\n          color = \"white\",\n          size = 0.1, na.rm = T) +\n  scale_fill_gradientn(\n    colors = palette_blue(10),\n    na.value = \"#d3d3d3\",\n    limits = c(0,1)\n  )+\n  guides(fill = guide_colorbar(\n    barheight = unit(0.1, units = \"in\"),\n    barwidth =  unit(4, units = \"in\"),\n    ticks.colour = \"grey20\",\n    title.position=\"top\", \n    title.hjust = 0.5\n  )) +\n  labs(\n    fill = \"Types\"\n  )+\n  theme_classic()+\n  theme(\n    legend.position = \"bottom\",\n    legend.margin = margin(-10,0,0,0,\"pt\"),\n    axis.text = element_blank(),  \n    axis.ticks = element_blank(),\n    axis.line = element_blank()\n  ) \n```\n\n## Plotting the two quantities (native and types turnover) in a bivariate map\n\n```{r}\nsf_bivar_types <-\n  bi_class(df_all_beta_sf2, \n           x = type.beta, \n           y = native.beta, \n           style = \"equal\",\n           dim = 4)\n\nbivar_map_types <- \n  ggplot() +\n  geom_sf(data = sf_bivar_types, \n          aes(geometry = geometry,\n              fill = bi_class), \n          color = \"white\",\n          size = 0.1, \n          show.legend = FALSE) +\n  bi_scale_fill(pal = \"DkBlue2\", \n                dim = 4) +\n  theme_classic()+\n  theme(\n    legend.position = \"bottom\",\n    legend.title = element_blank(),\n        axis.text = element_blank(),  \n        axis.ticks = element_blank(),\n        axis.line = element_blank(),\n    panel.background = element_rect(fill = NA),\n    plot.background = element_rect(fill = NA)\n  ) \n\nlegend <-\n  bi_legend(pal = \"DkBlue2\",\n            dim = 4,\n            xlab = \"NBT\",\n            ylab = \"Native\",\n            size = )\n\nbivar_map_type_final <- \n  ggdraw() +\n  draw_plot(legend, 0.0, 0.15, 0.25, 0.25) +\n  draw_plot(bivar_map_types, 0, 0, 1, 1)\n\n```\n\n## Joining all the maps \n\n```{r}\n#| fig-width: 10\n#| fig-height: 9\n\nmap_turnover_all <-\n  map_native_beta+map_type_beta+bivar_map_type_final+\n  patchwork::plot_layout(\n    design = \n\"AB\n CC\"\n  )+\n  patchwork::plot_annotation(tag_levels = \"a\")&\n  theme(\n    plot.tag = element_text(face = \"bold\", hjust = 0, vjust = 1),\n    plot.tag.position = c(0, 1),\n  )\nmap_turnover_all\n\nggsave(here::here(\"output\", \"figures\", \"FigS4_turnover_metrics.png\"),\n       map_turnover_all, dpi=600, width = 10, height = 9)\n\n```\n\n# Comparison between full dataset and endemic dataset\n\nWe performed correlations between Native and NBT turnover calculated using\n    the endemic dataset and the full dataset of native species\n\n```{r}\ndf_endemic_beta <- readr::read_csv(here::here(\"data\", \"processed\", \"df_endemic_beta.csv\"))\n\ndf_endemic_beta2 <- \n  df_endemic_beta |> \n  drop_na(type.beta) \ndf_all_beta_sf2 <- \n  df_all_beta_sf |> \n  drop_na(type.beta) \n\ndf_cor <- \n  df_endemic_beta2 |> \n  left_join(df_all_beta_sf2, by = c(countries = \"iso_a3_eh\")) \n\ncor(df_cor$type.beta.x, df_cor$type.beta.y)\ncor(df_cor$native.beta.x, df_cor$native.beta.y)\n\n```\n\n\n# Model results\n\nHere we report tables containing full results of the generalized linear models\n    presented in the main text . Also we report residuals diagnostic plots using\n    [DHARMa](https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html) package\n\n```{r}\nlibrary(sjPlot)    # creating summary tables of model results\nlibrary(glmmTMB)   # read model output objects\nlibrary(DHARMa)    # diagnostic graphics of models\nlibrary(here)      # constructing file paths\n```\n\n## Model data\n\nReading model results\n\n```{r}\n# Data from 03_C_data_preparation.qmd\ndf_country_complete6 <- readr::read_csv(here::here(\"data\", \"processed\", \"df_country_complete6.csv\"))\n\n# Data from 04_D_model_NBTs.qmd\nmod_counting_NBT <- readRDS(here::here(\"output\", \n                                       \"models\", \n                                       \"model_res_counting.rds\")) # NBT total countings\nmod_DC <- readRDS(here::here(\"output\", \n                             \"models\", \n                             \"model_res_dc.rds\"))\nmod_DR <- readRDS(here::here(\"output\", \n                             \"models\", \n                             \"model_res_dr.rds\"))\nmod_turnover_native <- readRDS(here::here(\"output\", \n                                          \"models\",\n                                      \"model_res_turnover_native.rds\"))\nmod_turnover_nbt <- readRDS(here::here(\"output\", \n                                       \"models\",\n                                       \"model_res_turnover_nbt.rds\"))\n\n```\n\n## Tables with estimated parameters\n\nProducing tables with model parameters. These tables corresponds to the Tables S1 to \n    S5 in the Supplementary material\n\n```{r}\n\n# Table with model parameters for total number of NBT\nsjPlot::tab_model(mod_counting_NBT, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\", \n                                  \"Dispersion parameter\"), \n                  dv.labels = \"Total Name Bearing Types\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n\n\n\n```\n\n```{r}\n# Table with parameter for Domestic contribution as the response variable\n\nsjPlot::tab_model(mod_DC, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"Domestic Contribution\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n\n```\n\n```{r}\n# Table with parameters for model with Domestic retention as response variable\n\nsjPlot::tab_model(mod_DR, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"Domestic Retention\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n```\n\n```{r}\n# Table with parameter from model with native turnover as response variable\n\nsjPlot::tab_model(mod_turnover_native, \n                  transform = NULL, \n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"Native turnover\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n```\n\n```{r}\n# Table with parameters from model with nbt turnover as response variable\n\nsjPlot::tab_model(mod_turnover_nbt, \n                  transform = NULL,\n                  pred.labels = c(\"Intercept\", \n                                  \"Native richness\",\n                                  \"Gbif records per area\",\n                                  \"Years since independence\", \n                                  \"GDP\", \n                                  \"Number of museums\"), \n                  dv.labels = \"NBT turnover\", \n                  string.pred = \"Coefficients\", \n                  string.est = \"Estimates\", \n                  string.p = \"P-value\")\n\n\n\n\n```\n\n\n## Diagnostic graphics\n\nQQ-plots and residuals x predicted plots using DHARMa package. These plots are \n    used to compose the Figure S4 in the Supplementary material\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# total number of NBT\nDHARMa::simulateResiduals(fittedModel = mod_counting_NBT, plot = T)\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# Domestic Contribution and Domestic Retention\nDHARMa::simulateResiduals(fittedModel = mod_DC, plot = TRUE) # DC\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\nDHARMa::simulateResiduals(fittedModel = mod_DR, plot = TRUE) # DR\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# native turnover\nDHARMa::simulateResiduals(fittedModel = mod_turnover_native, plot = TRUE)\n\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 5\n\n# NBT turnover\nDHARMa::simulateResiduals(fittedModel = mod_turnover_nbt, plot = TRUE)\n```\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"0010_Supplementary_analysis.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","theme":"cosmo","code-links":[{"text":"Source Code","icon":"file-code","href":"https://github.com/GabrielNakamura/NBT_code_data"}],"title":"Supplementary material - Figures and Tables","subtitle":"0010_Supplementary_analysis.qmd","knitr":{"opts_chunk":{"message":false}}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}